<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="img/logo.ico">
    <title>ДГТУ - Интерактивный путеводитель по университету. Интерактивная карта</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #B9D4FF;
            height: 100vh;
            width: 100vw;
        }

        #mapContainer {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            cursor: grab;
            background-color: #B9D4FF;
        }

        #mapContainer.grabbing {
            cursor: grabbing;
        }

        #mapWrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            image-rendering: crisp-edges;
            shape-rendering: geometricPrecision;
            transition: transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        #mapWrapper.zooming {
            transition: none;
        }

        #eventOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: inherit;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            color: #333;
            transition: all 0.2s;
            user-select: none;
            backdrop-filter: blur(5px);
            z-index: 101;
        }

        .control-btn:hover {
            background: white;
            transform: scale(1.08);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .zoom-info {
            position: fixed;
            bottom: 25px;
            left: 25px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            user-select: none;
            backdrop-filter: blur(5px);
            color: #222;
        }

        #svgIframe {
            position: absolute;
            top: 0;
            left: 0;
            border: none;
            display: block;
            overflow: visible;
            width: 10000px;
            height: 10000px;
            transform: translate(-50%, -50%);
            /* Скрываем скролл-бары у самого iframe */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        
        /* Скрываем скролл-бар в WebKit браузерах */
        #svgIframe::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }
        
        .iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: visible;
        }
    </style>
</head>
<body>
    <div class="zoom-info" id="zoomInfo">Масштаб: 12%</div>
    
    <div id="mapContainer">
        <div id="eventOverlay"></div>
        
        <div id="mapWrapper">
            <div class="iframe-container">
                <iframe id="svgIframe" title="SVG Map"></iframe>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn" id="zoomIn">+</button>
        <button class="control-btn" id="zoomOut">-</button>
        <button class="control-btn" id="reset">↻</button>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mapContainer = document.getElementById('mapContainer');
            const eventOverlay = document.getElementById('eventOverlay');
            const mapWrapper = document.getElementById('mapWrapper');
            const svgIframe = document.getElementById('svgIframe');
            const zoomInfo = document.getElementById('zoomInfo');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');
            const resetBtn = document.getElementById('reset');
            
            // 1. Начальный масштаб 12%
            let scale = 0.12;
            let targetScale = 0.12;
            let position = { x: 0, y: 0 };
            let targetPosition = { x: 0, y: 0 };
            let isDragging = false;
            let dragStart = { x: 0, y: 0 };
            let startPosition = { x: 0, y: 0 };
            let svgSize = { width: 0, height: 0 };
            
            let zoomAnimationId = null;
            let isAnimating = false;
            
            const MIN_SCALE = 0.05;
            const MAX_SCALE = 10;
            const SCALE_SENSITIVITY = 0.001;
            const ZOOM_SPEED = 0.15;
            const INERTIA_DECAY = 0.9;
            
            let containerWidth = mapContainer.clientWidth;
            let containerHeight = mapContainer.clientHeight;
            
            let wheelDelta = 0;
            let lastWheelTime = 0;
            let isZooming = false;
            
            function updateTransform(instant = false) {
                if (instant) {
                    mapWrapper.classList.add('zooming');
                    mapWrapper.style.transform = `matrix(${scale}, 0, 0, ${scale}, ${position.x}, ${position.y})`;
                } else {
                    mapWrapper.classList.remove('zooming');
                    mapWrapper.style.transform = `matrix(${scale}, 0, 0, ${scale}, ${position.x}, ${position.y})`;
                }
                zoomInfo.textContent = `Масштаб: ${Math.round(scale * 100)}%`;
                
                updateIframeStyles();
            }
            
            function animateZoom() {
                if (!isAnimating) return;
                
                const scaleDiff = targetScale - scale;
                const posDiffX = targetPosition.x - position.x;
                const posDiffY = targetPosition.y - position.y;
                
                if (Math.abs(scaleDiff) < 0.001 && Math.abs(posDiffX) < 0.5 && Math.abs(posDiffY) < 0.5) {
                    scale = targetScale;
                    position.x = targetPosition.x;
                    position.y = targetPosition.y;
                    isAnimating = false;
                    updateTransform();
                    return;
                }
                
                scale += scaleDiff * ZOOM_SPEED;
                position.x += posDiffX * ZOOM_SPEED;
                position.y += posDiffY * ZOOM_SPEED;
                
                updateTransform();
                zoomAnimationId = requestAnimationFrame(animateZoom);
            }
            
            function startZoomAnimation() {
                if (isAnimating) {
                    cancelAnimationFrame(zoomAnimationId);
                }
                isAnimating = true;
                zoomAnimationId = requestAnimationFrame(animateZoom);
            }
            
            function updateIframeStyles() {
                try {
                    const iframeDoc = svgIframe.contentDocument;
                    if (!iframeDoc) return;
                    
                    const svgElement = iframeDoc.querySelector('svg');
                    if (!svgElement) return;
                    
                    svgElement.style.vectorEffect = 'non-scaling-stroke';
                    svgElement.style.shapeRendering = 'geometricPrecision';
                    svgElement.style.textRendering = 'geometricPrecision';
                    svgElement.style.imageRendering = 'optimizeQuality';
                    svgElement.style.display = 'block';
                    svgElement.style.overflow = 'visible';
                    
                    const allElements = svgElement.querySelectorAll('*');
                    allElements.forEach(el => {
                        if (el.style) {
                            el.style.vectorEffect = 'non-scaling-stroke';
                            el.style.shapeRendering = 'geometricPrecision';
                        }
                    });
                    
                } catch (e) {
                    // Игнорируем ошибки CORS
                }
            }
            
            function centerMap() {
                if (svgSize.width > 0 && svgSize.height > 0) {
                    // Ключевое исправление: центрируем середину SVG
                    const containerCenterX = containerWidth / 2;
                    const containerCenterY = containerHeight / 2;
                    
                    // Находим центр SVG после масштабирования
                    const svgCenterX = svgSize.width * scale / 2;
                    const svgCenterY = svgSize.height * scale / 2;
                    
                    // Позиционируем так, чтобы центр SVG был в центре контейнера
                    position.x = containerCenterX - svgCenterX;
                    position.y = containerCenterY - svgCenterY;
                    
                    targetPosition.x = position.x;
                    targetPosition.y = position.y;
                    
                    updateTransform(true);
                    console.log('Карта центрирована:', { 
                        scale, 
                        position, 
                        svgSize, 
                        containerSize: { containerWidth, containerHeight } 
                    });
                    return true;
                } else {
                    console.log('Не могу центрировать: размеры SVG неизвестны');
                    return false;
                }
            }
            
            function loadAndCenterSVG() {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'img/map.svg', true);
                xhr.overrideMimeType('image/svg+xml');
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const parser = new DOMParser();
                        const svgDoc = parser.parseFromString(xhr.responseText, 'image/svg+xml');
                        const svgElement = svgDoc.querySelector('svg');
                        
                        if (svgElement) {
                            let width = svgElement.getAttribute('width');
                            let height = svgElement.getAttribute('height');
                            
                            if (!width || !height) {
                                const viewBox = svgElement.getAttribute('viewBox');
                                if (viewBox) {
                                    const parts = viewBox.split(' ');
                                    if (parts.length >= 4) {
                                        width = parts[2];
                                        height = parts[3];
                                    }
                                }
                            }
                            
                            svgSize.width = parseFloat(width) || 1000;
                            svgSize.height = parseFloat(height) || 1000;
                            
                            console.log('Размеры SVG определены:', svgSize);
                            
                            const iframeHTML = `
                                <!DOCTYPE html>
                                <html>
                                <head>
                                    <meta charset="UTF-8">
                                    <style>
                                        * {
                                            margin: 0;
                                            padding: 0;
                                            box-sizing: border-box;
                                        }
                                        html, body {
                                            width: ${svgSize.width}px;
                                            height: ${svgSize.height}px;
                                            overflow: visible !important;
                                            background: transparent;
                                            scrollbar-width: none;
                                            -ms-overflow-style: none;
                                        }
                                        html::-webkit-scrollbar,
                                        body::-webkit-scrollbar {
                                            display: none;
                                            width: 0;
                                            height: 0;
                                        }
                                        svg {
                                            display: block;
                                            overflow: visible !important;
                                        }
                                    </style>
                                </head>
                                <body>
                                    ${xhr.responseText}
                                </body>
                                </html>
                            `;
                            
                            const iframeDoc = svgIframe.contentDocument || svgIframe.contentWindow.document;
                            iframeDoc.open();
                            iframeDoc.write(iframeHTML);
                            iframeDoc.close();
                            
                            svgIframe.style.width = svgSize.width + 'px';
                            svgIframe.style.height = svgSize.height + 'px';
                            
                            // Сначала обновляем стили
                            updateIframeStyles();
                            
                            // Затем центрируем карту
                            setTimeout(() => {
                                centerMap();
                            }, 50);
                        }
                    }
                };
                
                xhr.onerror = function() {
                    console.log('Ошибка загрузки SVG, пробуем через object');
                    const iframeHTML = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <style>
                                * {
                                    margin: 0;
                                    padding: 0;
                                    box-sizing: border-box;
                                }
                                html, body {
                                    width: 100%;
                                    height: 100%;
                                    overflow: visible !important;
                                    background: transparent;
                                    scrollbar-width: none;
                                    -ms-overflow-style: none;
                                }
                                html::-webkit-scrollbar,
                                body::-webkit-scrollbar {
                                    display: none;
                                    width: 0;
                                    height: 0;
                                }
                                svg {
                                    display: block;
                                    overflow: visible !important;
                                }
                            </style>
                        </head>
                        <body>
                            <object data="img/map.svg" type="image/svg+xml" width="100%" height="100%">
                                Ваш браузер не поддерживает SVG
                            </object>
                        </body>
                        </html>
                    `;
                    
                    const iframeDoc = svgIframe.contentDocument || svgIframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(iframeHTML);
                    iframeDoc.close();
                    
                    setTimeout(() => {
                        try {
                            const iframeDoc = svgIframe.contentDocument;
                            const svgElement = iframeDoc.querySelector('svg') || 
                                             (iframeDoc.querySelector('object') && 
                                              iframeDoc.querySelector('object').contentDocument && 
                                              iframeDoc.querySelector('object').contentDocument.querySelector('svg'));
                            
                            if (svgElement) {
                                const bbox = svgElement.getBBox();
                                svgSize.width = bbox.width + bbox.x;
                                svgSize.height = bbox.height + bbox.y;
                                
                                console.log('Размеры SVG определены через BBox:', svgSize);
                                
                                svgIframe.style.width = svgSize.width + 'px';
                                svgIframe.style.height = svgSize.height + 'px';
                                
                                updateIframeStyles();
                                
                                // Центрируем карту
                                setTimeout(() => {
                                    centerMap();
                                }, 100);
                            }
                        } catch(e) {
                            console.warn('Не удалось определить размеры SVG:', e);
                        }
                    }, 500);
                };
                
                try {
                    xhr.send();
                } catch (e) {
                    xhr.onerror();
                }
            }
            
            function handleZoom(delta, clientX, clientY, instant = false) {
                const rect = mapContainer.getBoundingClientRect();
                const mouseX = clientX - rect.left;
                const mouseY = clientY - rect.top;
                
                const worldX = (mouseX - position.x) / scale;
                const worldY = (mouseY - position.y) / scale;
                
                targetScale = scale + delta;
                targetScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, targetScale));
                
                targetPosition.x = mouseX - worldX * targetScale;
                targetPosition.y = mouseY - worldY * targetScale;
                
                if (instant) {
                    scale = targetScale;
                    position.x = targetPosition.x;
                    position.y = targetPosition.y;
                    updateTransform(true);
                } else {
                    startZoomAnimation();
                }
            }
            
            eventOverlay.addEventListener('wheel', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const now = Date.now();
                const timeDiff = now - lastWheelTime;
                lastWheelTime = now;
                
                let delta = -e.deltaY * SCALE_SENSITIVITY;
                delta = Math.max(-0.15, Math.min(0.15, delta));
                
                if (timeDiff < 50) {
                    delta *= 1.5;
                }
                
                wheelDelta += delta;
                wheelDelta *= INERTIA_DECAY;
                
                handleZoom(wheelDelta, e.clientX, e.clientY, false);
                
                if (isZooming) {
                    clearTimeout(isZooming);
                }
                isZooming = setTimeout(() => {
                    wheelDelta = 0;
                }, 150);
                
            }, { passive: false });
            
            eventOverlay.addEventListener('mousedown', function(e) {
                if (e.button === 0) {
                    isDragging = true;
                    mapContainer.classList.add('grabbing');
                    eventOverlay.style.cursor = 'grabbing';
                    dragStart.x = e.clientX;
                    dragStart.y = e.clientY;
                    startPosition.x = position.x;
                    startPosition.y = position.y;
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                
                position.x = startPosition.x + dx;
                position.y = startPosition.y + dy;
                targetPosition.x = position.x;
                targetPosition.y = position.y;
                
                updateTransform(true);
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    mapContainer.classList.remove('grabbing');
                    eventOverlay.style.cursor = 'grab';
                }
            });
            
            eventOverlay.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1) {
                    isDragging = true;
                    dragStart.x = e.touches[0].clientX;
                    dragStart.y = e.touches[0].clientY;
                    startPosition.x = position.x;
                    startPosition.y = position.y;
                    e.preventDefault();
                }
            }, { passive: false });
            
            eventOverlay.addEventListener('touchmove', function(e) {
                if (isDragging && e.touches.length === 1) {
                    const dx = e.touches[0].clientX - dragStart.x;
                    const dy = e.touches[0].clientY - dragStart.y;
                    
                    position.x = startPosition.x + dx;
                    position.y = startPosition.y + dy;
                    targetPosition.x = position.x;
                    targetPosition.y = position.y;
                    
                    updateTransform(true);
                    e.preventDefault();
                }
            }, { passive: false });
            
            eventOverlay.addEventListener('touchend', function() {
                isDragging = false;
            });
            
            zoomInBtn.addEventListener('click', function() {
                handleZoom(0.2, containerWidth / 2, containerHeight / 2, true);
            });
            
            zoomOutBtn.addEventListener('click', function() {
                handleZoom(-0.2, containerWidth / 2, containerHeight / 2, true);
            });
            
            resetBtn.addEventListener('click', function() {
                scale = 0.12;
                targetScale = 0.12;
                centerMap();
            });
            
            window.addEventListener('resize', function() {
                containerWidth = mapContainer.clientWidth;
                containerHeight = mapContainer.clientHeight;
                centerMap();
            });
            
            eventOverlay.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            eventOverlay.style.cursor = 'grab';
            loadAndCenterSVG();
            updateTransform(true);

            svgSize.width = 1;
            svgSize.height = 1;
            centerMap();
        });
    </script>
</body>
</html>